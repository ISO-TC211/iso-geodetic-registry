AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Globals:
    Api:
        # API Gateway regional endpoints
        EndpointConfiguration: REGIONAL

Resources:
    PetStoreFunction:
        Type: AWS::Serverless::Function
        Properties:
            Handler: org.iso.registry.client.StreamLambdaHandler::handleRequest
            Runtime: java8
            CodeUri: target/isoreg-lambda.zip
            MemorySize: 1512
            Policies: AWSLambdaBasicExecutionRole
            Timeout: 60
            Environment:
                Variables:
                    hibernate.connection.url: !Ref hibernate.connection.url
                    hibernate.connection.username: !Ref hibernate.connection.username
                    hibernate.connection.password: !Ref hibernate.connection.password
                    hibernate.connection.dialect: !Ref hibernate.connection.dialect
                    hibernate.connection.hbm2ddl.driver_class: !Ref hibernate.connection.driver_class
                    hibernate.hbm2ddl.auto: !Ref hibernate.hbm2ddl.auto
                    flyway.migration: !Ref flyway.migration
#                    registry.demoMode: !Ref registry.demoMode
            Events:
                GetResource:
                    Type: Api
                    Properties:
                        Path: /{proxy+}
                        Method: any

Parameters:
    hibernate.connection.url:
        Default: "jdbc:postgresql://db:5432/isoreg"
    hibernate.connection.username:
        Default: "isoreg"
    hibernate.connection.password:
        Default: "isoreg"
    hibernate.connection.dialect:
        Default: "org.hibernate.dialect.PostgreSQL9Dialect"
    hibernate.connection.driver_class:
        Default: "org.postgresql.Driver"
    hibernate.hbm2ddl.auto:
        Default: "validate"
    flyway.migration:
        Default: "repairAndMigrate"

Outputs:
    IsoRegistryApi:
        Description: URL for application
        Value: !Sub 'https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/isoreg'
        Export:
            Name: IsoRegistryApi
